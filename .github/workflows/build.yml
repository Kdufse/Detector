name: Android CI

on:
  push:
    branches: [ main, develop, feature/* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

env:
  # Java版本
  JAVA_VERSION: '17'
  
  # Gradle配置
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'
  
  # 缓存配置
  GRADLE_CACHE_KEY: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
  BUILD_CACHE_KEY: build-${{ runner.os }}-${{ github.sha }}

jobs:
  # 代码质量检查
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ env.GRADLE_CACHE_KEY }}
        restore-keys: |
          gradle-${{ runner.os }}-
          
    - name: Cache Build
      uses: actions/cache@v4
      with:
        path: |
          **/build
        key: ${{ env.BUILD_CACHE_KEY }}
        
    - name: Run ktlint check
      run: ./gradlew ktlintCheck --no-daemon
      
    - name: Run detekt check
      run: ./gradlew detekt --no-daemon
      
    - name: Check dependency licenses
      run: ./gradlew checkLicense --no-daemon
      
    - name: Check for dependency updates
      run: ./gradlew dependencyUpdates --no-daemon

  # 构建和测试
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: quality
    
    strategy:
      matrix:
        variant: [Debug, Release]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ env.GRADLE_CACHE_KEY }}
        restore-keys: |
          gradle-${{ runner.os }}-
          
    - name: Cache Build
      uses: actions/cache@v4
      with:
        path: |
          **/build
        key: ${{ env.BUILD_CACHE_KEY }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
        
    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew :app:assemble${{ matrix.variant }} --no-daemon
        
    - name: Run unit tests
      run: ./gradlew :app:test${{ matrix.variant }}UnitTest --no-daemon
      
    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.variant }}
        path: |
          **/build/reports/tests
          **/build/test-results
        retention-days: 7
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ matrix.variant }}
        path: |
          **/build/outputs/apk/${{ lower(matrix.variant) }}/*.apk
          **/build/outputs/bundle/${{ lower(matrix.variant) }}/*.aab
        retention-days: 7

  # 发布到GitHub Releases
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ env.GRADLE_CACHE_KEY }}
        restore-keys: |
          gradle-${{ runner.os }}-
          
    - name: Download APK artifacts
      uses: actions/download-artifact@v4
      with:
        name: apk-Release
        path: artifacts
        
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/**/*.apk
          artifacts/**/*.aab
        
    - name: Upload to Firebase App Distribution
      if: ${{ env.FIREBASE_APP_ID != '' && env.FIREBASE_TOKEN != '' }}
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        token: ${{ secrets.FIREBASE_TOKEN }}
        groups: testers
        file: artifacts/**/*.apk

  # 安全扫描
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'RootDetector'
        path: '.'
        format: 'HTML'
        out: 'reports'
        
    - name: Upload OWASP report
      uses: actions/upload-artifact@v4
      with:
        name: owasp-report
        path: reports/
        retention-days: 7